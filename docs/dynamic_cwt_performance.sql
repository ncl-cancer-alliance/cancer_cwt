CREATE OR REPLACE DYNAMIC TABLE DATA_LAB_NCL_TRAINING_TEMP.CANCER_CWT.CWT_PERFORMANCE (
    RECORD_ID VARCHAR,
	PER_DATE_YEAR NUMBER,
	PER_DATE_MONTH NUMBER,
	PER_ORG_TRUST VARCHAR,
	PER_ORG_SITE VARCHAR,
	PER_ORG_NCL BOOLEAN,
	PER_METRIC VARCHAR,
	PER_VALUE NUMBER,
	PER_NUMERATOR NUMBER,
	PER_DENOMINATOR NUMBER
)
COMMENT="Dynamic table containing performance metrics for CWT data."
TARGET_LAG = "2 hours"
REFRESH_MODE = FULL
INITIALIZE = ON_CREATE
WAREHOUSE = NCL_ANALYTICS_XS
AS
--CTE to get parent organisation for site columns
WITH org_par AS (
    SELECT child."Organisation_Code" AS "ORG_SITE", par."Organisation_Code" AS "ORG_TRUST"
    FROM "Dictionary"."dbo"."Organisation" child

    LEFT JOIN "Dictionary"."dbo"."Organisation" par 
    ON child."SK_OrganisationID_ParentOrg" = par."SK_OrganisationID"
)

--Combine Performance metrics into 1 table
SELECT * FROM DATA_LAB_NCL_TRAINING_TEMP.CANCER_CWT.CWT_PERFORMANCE_2WW
UNION ALL
SELECT * FROM DATA_LAB_NCL_TRAINING_TEMP.CANCER_CWT.CWT_PERFORMANCE_FDS
UNION ALL
SELECT * FROM DATA_LAB_NCL_TRAINING_TEMP.CANCER_CWT.CWT_PERFORMANCE_31DAY_FIRST
UNION ALL
SELECT * EXCLUDE D31_BREAKDOWN 
FROM DATA_LAB_NCL_TRAINING_TEMP.CANCER_CWT.CWT_PERFORMANCE_31DAY_SUBSEQUENT